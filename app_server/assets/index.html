<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Оплата</title>
    <meta name="color-scheme" content="only light">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Nunito">
    <link rel="stylesheet" type="text/css" href="/css/main.css">
    <style>
        #pay-btn:disabled {
            background: dimgray;
        }
    </style>
</head>
<body>
    <div class="window">
        <div class="form">
            <div class="head">
                <img src="/static/логотип тбанка.png" width="100"/>
                <h1>Оформить подписку</h1>
                <span>услуги на подключение к нашим серверам бота TRIO на 1 месяц</span>
                <span>Описание: Вы оплачиваете за ключ, который выдал вам бот. На котором имеется доступ к нашему VPN сервису  в течение 1 месяца.</span>
            </div>
            <div class="info">
                <div class="sum">
                    <span>Стоимость:</span>
                    <span>150₽</span>
                </div>
                <div class="sum">
                    <span>Итого:</span>
                    <span>150₽</span>
                </div>
            </div>
            <div class="agree">
                <label class="container">Согласен с условиями оферты.
                    <input type="checkbox" class="required-checkbox">
                    <span class="checkmark"></span>
                </label>
                <label class="container">Согласен с обработкой персональных данных
                    <input type="checkbox" class="required-checkbox">
                    <span class="checkmark"></span>
                </label>
                <label class="container">Согласен с подпиской
                    <input type="checkbox" class="required-checkbox">
                    <span class="checkmark"></span>
                </label>
            </div>
            <div class="pay-button-container">
                <button class="pay-btn" id="pay-method-card" disabled>Оплатить по карте</button>
                <button class="pay-btn" id="pay-method-qr" disabled>Оплатить по QR</button>
            </div>

            <p>ИП АБдулаев Мухаммад Мурадович</p>
            <p>ИНН: 057204730881</p>
            <p>ОГРН: 325050000001862</p>
            <p>Расчетный счет: 40802810300007713048 </p>
            <p>Корреспондентский счет: 30101810145250000974</p>
            <p>БИК: 044525974</p>
        </div>
    </div>
    <div class="footer">
    <div>
        <div id="cancel-subscription">Для отмены подписки нажмите сюда или свяжитесь с нами по данным из раздела Контакты</div>
    </div>
    <div style="display: flex; flex-direction: column; gap: 20px;">
        <a href="/static/Оферта т.pdf">Оферта</a>
        <a href="/static/Согласие_на_обработку_персональных_данных т.pdf">Согласие на обработку персональных данных</a>
        <a href="/static/Соглашение с подпиской т.pdf">Соглашение с подпиской</a>
    </div>
    <h1>Контакты</h1>
        <div class="grey">
            <a href="tel:+79654910011">+7 (965) 491-00-11</a>
            <a href="mailto:mukhammad_368300@mail.ru">mukhammad_368300@mail.ru</a>
        </div>
    </div>

    <script>
        class _API {
            constructor(taskId, baseUrl="/api") {
                this.taskId = taskId;
                this.baseUrl = baseUrl
            }

            makeRequest(endpoint="/", json={}) {
                return fetch(this.baseUrl + endpoint, {
                    headers: {
                        "Content-Type": "application/json",
                    },
                    method: "POST",
                    body: JSON.stringify({
                        task_id: this.taskId,
                        ...json
                    }),
                })
            }

            getQrLink() {
                this.makeRequest("/get-qr-link")
                    .then(response => {
                        if (response.status != 200)
                            throw new Error(response.message);
                        return response;
                    })
                    .then(response => response.json())
                    .then(response => {
                        history.pushState({}, "", (response.json()).link);
                    })
                    .catch(error => {
                        console.error(error);
                        alert("Возникла ошибка при совершении запроса");
                    })
            }

            cancel_subscription(taskId) {
                this.makeRequest("/cancel-subscription", {task_id: taskId})
                    .then(response => {
                        if (response.status == 202)
                            alert("Подпискка успешно отменена");
                        else {
                            throw new Error(response.message);
                        }
                    })
                    .catch(error => {
                        console.error(error);
                        alert("Не удалось отменить подписку. Свяжитесь с поддержкой для отмены.\nДетали: " + error)
                    })
            }
        }
        const API = _API;
    </script>

    <script>
        // utils:
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);


        // url parsing:
        const urlParams = new URLSearchParams(window.location.search);
        const taskId = urlParams.get('task');
        const utmSource = urlParams.get('utm_source') || "tg";

        if (!taskId || !utmSource)
            alert("Неправильная ссылка!");

        // create API Instance
        const Api = new API(taskId, baseUrl="/api/cp");
        

        //  button bindings:
        const cancel_btn = $("#cancel-subscription");
        cancel_btn.addEventListener('click', () => {
            cancel_btn.setAttribute("disabled", "")
            Api.cancel_subscription(taskId);
            setTimeout(() => {cancel_btn.removeAttribute("disabled");}, 5000);
        });

        const payMethodCardButton = $("#pay-method-card");
        payMethodCardButton.addEventListener('click', () => {
            payMethodCardButton.setAttribute("disabled", "")
            // TODO: use widget
            setTimeout(() => {payMethodCardButton.removeAttribute("disabled");}, 5000);
        });

        const payMethodQRButton = $("#pay-method-qr");
        payMethodQRButton.addEventListener('click', () => {
            payMethodQRButton.setAttribute("disabled", "")
            Api.getQrLink(taskId);
            setTimeout(() => {payMethodQRButton.removeAttribute("disabled");}, 5000);
        });


        // checkbox for button
        const checkboxes = $$('.required-checkbox');
        const payButtons = $$(".pay-btn");

        for(let checkbox of checkboxes) {
            checkbox.addEventListener('change', (event) => {
                console.log(checkboxes);
                var all_captured = Array.from(checkboxes).every(elem => elem.checked);
                // enabling buttons
                for (let payButton of payButtons) {
                    all_captured 
                        ? payButton.removeAttribute("disabled")
                        : payButton.setAttribute("disabled", "true");
                }
                console.log("update pay buttons state:", all_captured);
            });
        }
    </script>
</body>


</html>
